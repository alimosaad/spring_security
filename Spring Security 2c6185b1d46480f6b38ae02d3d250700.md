# Spring Security

# **Introduction to Spring Security**

- **Spring Security is a powerful and highly customizable authentication and access-control framework for Java applications. It is the de-facto standard for securing Spring-based applications and provides comprehensive security services for Java EE-based enterprise software applications.**
- **It’s a spring project that provide security to an application .**
- **provide authentication logic and form login , JWT authentication , Authorization → at level of req or at level of method**

## **Core Features**

- **Authentication and Authorization**
- **Protection against common security threats (CSRF, Session Fixation, Clickjacking)**
- **Integration with various authentication mechanisms (LDAP, OAuth, SAML)**
- **Method-level security**
- **Password encoding and encryption**

---

## **Authentication**

- **Core of spring security**
- **Are you who are you say you are ? هو انت انت بيتأكد ان هو الششخص اللي بيحاول يسجل دخول**
- **check using credentials → userName , password OR fingerPrint OR any methods for Login**

## Authorization

- **Do you have the authority to perform an action ?**
- **There are more way to perform an authorization**
    1. **RBAC (Role - Based - Access - Control) → بيتأكد ان اليوزر عنده الصلاحية دي ولا لاء → if yes , continue . else → throw an exception.**
    2. **ABAC (Attribute - Based - Access - Control)** 
        - **دي لو عندي يوزر ليه صلاحيات علي سيستم حكومي والموظف ممكن يعمل حاجة غلط بعد ساعات العمل ف لاء من خلال الطريقة دي اقدر اتحكم علي الصلاحيات خلال وقت العمل فقط زي مثلا من 9 إلى 5 فقط .**
        - **او مثلا هو بيعمل دخول الساعة كام ؟**
        - **او بيعمل دخول منين ؟**
    3. **REBAC**
        - **هل الuser هو اللي عمل الحاجة دى؟**
        - **لو أه → اذاً يقدر يعدلها هو او اي حد فوقه حد فيه بينهم علاقة (ADMIN)**
        - **لو لاء → يبقي ميقدرش يعدل او يسمح**
        
        **هو الخلاصة ان الـ REBAC بيشتغل علي أساس العلاقة بين اليوزر والـ Resource اللي هو عايز يوصل**
        
         **ليها.**
        
        ![image.png](image.png)
        

---

## Spring Security Architecture

- قبل بداية كتابة الكود لازم نفهم ال Architecture ازاي بيحصل السيكيورتي
- **spring security is based on servlet filter e.g. → tomcat or jetty ,…..etc.**

![image.png](image%201.png)

# **How it work ?**

1. The client sends a request to the application.
2. the container creates a `FilterChain`, which contains the `Filter` instances and `Servlet` that should process the `HttpServletRequest`.
3. request turn in endpoint to specific servlet based on URL , servlet contain business logic.
    
    ![image.png](image%202.png)
    

## **Delegating Filter Proxy ?**

- Spring Security بيحط فلتر بين → servlet container and  Application context
- لو محتاج اعمل register delegating filter proxy و الفلتر دا هو Bean ف انا هحتاج اقوم ال app context وبعدين ال filter دا .
- ال **Delegating Filter Proxy دا بيبقي ك placeholder لما بيتنادي اول مرة علي run of app  the placeholder lookup the filter bean in app context.**
- وينادي عليها وياخد ال result ويرجعها .

## **Filter Chain Proxy ?**

- **هو فلتر بيحتوي علي مجموعة من الـ Security Filters اللي بتتنفذ بترتيب معين.**
- بيسمح لـ Spring Security انها تدير multiple filter chains لكل request based on the URL pattern.
- كل filter chain بتحتوي علي security filters مختلفة حسب الـ security requirements.

![image.png](image%203.png)

---

## **Security Filter Chain ?**

- **هي مجموعة من الـ Security Filters المرتبة بترتيب معين اللي بتتنفذ لكل request.**
- **الـ FilterChainProxy بيختار الـ SecurityFilterChain المناسبة based on the request URL pattern.**
- **كل filter بيعمل مهمة أمنية محددة زي authentication, authorization, CSRF protection, etc.**

![image.png](image%204.png)

- **Security Filter in SecurityFilterChain are typically  beans ,registered with FilterChainProxy**

---

## Security Filters ?

- **الـ Security Filters بتتحط جوه الـ FilterChainProxy من خلال الـ SecurityFilterChain API.**
- **الـ Filters دي بتستخدم لأغراض مختلفة زي exploit protection, authentication, authorization, وغيرها.**
- **الـ Filters بتتنفذ بترتيب معين عشان نضمن إنها بتتنادى في الوقت الصح.**
- **مثلاً: الـ Filter اللي بيعمل authentication لازم يتنادى قبل الـ Filter اللي بيعمل authorization.**

---

## **Adding Filters to the Filter Chain ?**

- **في Spring Security، بنقدر نضيف custom filters للـ Filter Chain عشان نعمل custom security logic.**
- **بنستخدم الـ `HttpSecurity` configuration عشان نضيف الـ filters في مكان معين في الـ chain باستخدام methods زي `addFilterBefore(filter,class<?>)`, `addFilterAfter(filter,class<?>)`, أو `addFilterAt(filter,class<?>)`.**
- **مثال: لو عايزين نضيف custom authentication filter قبل الـ `sernamePasswordAuthenticationFilter`:**

### **Adding a Custom Filter ?**

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .addFilterBefore(new CustomAuthenticationFilter(), 
                           UsernamePasswordAuthenticationFilter.class);
        return http.build();
    }
}
```

**في المثال ده، احنا بنضيف `CustomAuthenticationFilter` قبل الـ`UsernamePasswordAuthenticationFilter` في الـ filter chain.**

---

## **Handling Security Exceptions ?**

- **الـ `ExceptionTranslationFilter` بيسمح لـ Spring Security بترجمة الـ `AccessDeniedException` والـ `AuthenticationException` لـ HTTP responses.**
- **الـ `ExceptionTranslationFilter` بيتحط كـ Security Filter في الـ `FilterChainProxy`.**

### How Exception Translation Filter work ?

1. **أولاً: الـ `ExceptionTranslationFilter` بينادي على `FilterChain.doFilter(request, response)` عشان ينفذ باقي الـ application.**

![exceptiontranslationfilter.png](exceptiontranslationfilter.png)

1. **لو اليوزر مش authenticated أو في `AuthenticationException`، يبدأ *Start Authentication*:**
    - **الـ `SecurityContextHolder` بيتمسح (cleared out).**
    - **الـ `HttpServletRequest` بيتحفظ (saved) عشان نقدر نستخدمه تاني لما الـ authentication ينجح.**
    - **الـ `AuthenticationEntryPoint` بيستخدم عشان يطلب credentials من الـ client. مثلاً، ممكن يعمل redirect لصفحة الـ login أو يبعت `WWW-Authenticate` header.**
2. **لو كان `AccessDeniedException`، يبقى *Access Denied*:**
    - **الـ `AccessDeniedHandler` بيتنادى عليه عشان يتعامل مع access denied (الوصول المرفوض).**

---

## **Saving Requests Between Authentication?**

- **لما اليوزر مش authenticated، الـ `HttpServletRequest` بيتحفظ في الـ `RequestCache` عشان نقدر نرجع لنفس الـ request بعد ما الـ authentication ينجح.**
- **بمجرد ما اليوزر يعمل authentication بنجاح، بنستخدم الـ `RequestCache` عشان نسترجع الـ original request ونكمل الـ processing.**
- **الـ `RequestCacheAwareFilter` هو المسؤول عن استرجاع الـ saved request من الـ `RequestCache`.**

## **Prevent the Request From Being Saved  ?**

- **في بعض الحالات، مش عايزين نحفظ الـ original request بعد الـ authentication. مثلاً، لو اليوزر كان بيحاول يوصل لصفحة محمية وعايزين نوجهه لصفحة تانية بعد الـ login بدل ما نرجعه للصفحة الأصلية.**
- **في الحالة دي، بنقدر نمنع الـ request من إنه يتحفظ باستخدام الـ `NullRequestCache` أو من خلال تعطيل الـ `RequestCache` في الـ configuration.**

![image.png](image%205.png)